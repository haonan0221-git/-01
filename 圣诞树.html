<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åŒ—åŒ—çš„åœ£è¯æ ‘</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: "Microsoft YaHei", sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* 1. å¯åŠ¨å±‚ */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        /* æŒ‰é’®æ ·å¼ï¼šé»˜è®¤ç°è‰²ï¼ŒåŠ è½½å¥½åå˜è‰² */
        #start-btn {
            padding: 15px 40px; border: 2px solid #555; background: #222;
            color: #888; font-size: 18px; border-radius: 30px; 
            cursor: not-allowed; pointer-events: none; /* é»˜è®¤ä¸å¯ç‚¹ */
            box-shadow: none; text-transform: uppercase; font-weight: bold;
            transition: all 0.3s;
        }
        /* æ¿€æ´»çŠ¶æ€ */
        #start-btn.ready {
            border-color: #FFD700; background: rgba(255, 215, 0, 0.1);
            color: #FFD700; cursor: pointer; pointer-events: auto;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }

        /* 2. æ ‡é¢˜æ–‡å­— */
        #main-title {
            position: absolute; top: 12%; width: 100%; text-align: center;
            font-size: 40px; font-weight: bold; color: #fff;
            text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700;
            z-index: 5; pointer-events: none; letter-spacing: 5px;
            animation: glow 3s infinite alternate;
        }
        @keyframes glow {
            from { text-shadow: 0 0 10px #FFD700; opacity: 0.9; }
            to { text-shadow: 0 0 30px #FFD700, 0 0 50px #FF4500; opacity: 1; }
        }

        /* 3. é”™è¯¯æ—¥å¿—æ˜¾ç¤ºåŒº (å±å¹•å·¦ä¸‹è§’) */
        #error-log {
            position: fixed; bottom: 0; left: 0; width: 100%; max-height: 150px;
            background: rgba(50, 0, 0, 0.9); color: #ffaaaa; 
            font-size: 12px; z-index: 2000; overflow-y: auto;
            padding: 10px; pointer-events: none; display: none;
            font-family: monospace; white-space: pre-wrap;
        }

        /* UI */
        #ui-layer { pointer-events: none; position: absolute; width: 100%; height: 100%; z-index: 10; top:0; left:0;}
        .hud-bottom { position: absolute; bottom: 20px; width: 100%; text-align: center; color: rgba(255,255,255,0.4); font-size: 12px; }
        #gesture-status {
            position: absolute; bottom: 15%; width: 100%; text-align: center;
            color: rgba(255,255,255,0.3); font-size: 18px; font-weight: bold;
            text-shadow: 0 2px 4px #000; transition: 0.2s;
        }
        .active-gesture { color: #FFD700 !important; text-shadow: 0 0 20px #FFD700; transform: scale(1.1); }
        #video-feed {
            position: absolute; top: 10px; right: 10px; width: 80px; height: 100px;
            transform: scaleX(-1); border: 1px solid #444; opacity: 0.3; object-fit: cover; z-index: 20; border-radius: 5px;
        }
        @media (max-width: 600px) { #main-title { font-size: 32px; top: 10%; } }
    </style>

    <script>
        window.onerror = function(msg, url, line, col, error) {
            var log = document.getElementById('error-log');
            log.style.display = 'block';
            log.innerHTML += "âš ï¸ é”™è¯¯: " + msg + "\n";
            return false;
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="start-overlay">
        <h1 style="color:#FFD700; margin-bottom: 20px; text-shadow: 0 0 10px #FF4500;">ğŸ„ åŒ—åŒ—çš„åœ£è¯æ ‘</h1>
        <button id="start-btn">â³ èµ„æºåŠ è½½ä¸­...</button>
        <div style="margin-top: 15px; font-size: 12px; color: #888;">éœ€å…è®¸æ‘„åƒå¤´æƒé™ä»¥è¯†åˆ«æ‰‹åŠ¿</div>
    </div>

    <div id="main-title">åŒ—åŒ—çš„åœ£è¯æ ‘</div>
    <div id="error-log"></div>

    <div id="ui-layer">
        <div id="gesture-status">ç­‰å¾…æ‰‹åŠ¿...</div>
        <div class="hud-bottom">ğŸ– å¼ å¼€æ•£å¼€ | âœŠ æ¡æ‹³åˆæ‹¢ | ğŸ‘Œ æåˆçœ‹ç…§ç‰‡</div>
    </div>

    <video id="video-feed" playsinline muted></video>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // 1. æ¿€æ´»æŒ‰é’®é€»è¾‘
        const btn = document.getElementById('start-btn');
        btn.innerText = "âœ¨ ç‚¹å‡»å¼€å¯é­”æ³•";
        btn.classList.add('ready');
        
        btn.addEventListener('click', async function() {
            if(!this.classList.contains('ready')) return;
            this.innerText = "æ­£åœ¨å¯åŠ¨...";
            try {
                await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                document.getElementById('start-overlay').style.display = 'none';
                initThree();
                initMediaPipe();
            } catch (e) {
                this.innerText = "âŒ å¯åŠ¨å¤±è´¥";
                alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å…è®¸æƒé™ä¸”ä½¿ç”¨HTTPSè®¿é—®ã€‚");
            }
        });

        // --- é…ç½®åŒº ---
        const MY_PHOTOS = [
            'photos/1.jpg',
            'photos/2.jpg',
            'photos/3.jpg',
            'photos/4.jpg',
            'photos/5.jpg',
            'photos/6.jpg'
        ];

        const CONFIG = {
            colors: { gold: 0xFFD700, red: 0xDC143C, dark: 0x1a1a1a },
            particleCount: 1200, 
            treeHeight: 650,
            treeRadius: 280,
            // ç…§ç‰‡äº®åº¦è®¾ç½®
            photoBrightness: {
                normal: { intensity: 0.4, color: {r:1, g:1, b:1} }, // æ­£å¸¸çŠ¶æ€ï¼šè¾ƒäº®
                zoomed: { intensity: 0.05, color: {r:0.6, g:0.6, b:0.6} } // æ”¾å¤§çŠ¶æ€ï¼šå˜æš—
            }
        };

        let scene, camera, renderer, composer;
        let particles = [], photos = [];
        let geometryGroup = new THREE.Group();
        let photoGroup = new THREE.Group();
        let currentMode = 'TREE';
        let activePhoto = null;
        let targetRotX = 0, targetRotY = 0;

        function initThree() {
            try {
                const container = document.getElementById('canvas-container');
                scene = new THREE.Scene();
                scene.fog = new THREE.FogExp2(0x000000, 0.0008);

                camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 1, 2500);
                camera.position.set(0, 100, 1000);

                renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.toneMapping = THREE.ACESFilmicToneMapping;
                renderer.toneMappingExposure = 1.3;
                container.appendChild(renderer.domElement);

                const ambient = new THREE.AmbientLight(0xffffff, 1.2);
                scene.add(ambient);
                const topLight = new THREE.PointLight(CONFIG.colors.gold, 4.0, 1500);
                topLight.position.set(0, 600, 100);
                scene.add(topLight);
                const bottomLight = new THREE.PointLight(CONFIG.colors.red, 2.5, 1000);
                bottomLight.position.set(0, -400, 200);
                scene.add(bottomLight);

                const renderScene = new RenderPass(scene, camera);
                // è¾‰å…‰è®¾ç½®
                const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
                bloom.threshold = 0.15; bloom.strength = 1.8; bloom.radius = 0.8;
                
                composer = new EffectComposer(renderer);
                composer.addPass(renderScene);
                composer.addPass(bloom);

                addTopOrnament();
                createDecorations();
                loadMyPhotos();

                scene.add(geometryGroup);
                scene.add(photoGroup);

                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    composer.setSize(window.innerWidth, window.innerHeight);
                });
                animate();
            } catch(e) {
                alert("3D åˆå§‹åŒ–å¤±è´¥: " + e.message);
            }
        }

        function addTopOrnament() {
            const geo = new THREE.OctahedronGeometry(40, 0);
            const mat = new THREE.MeshStandardMaterial({
                color: CONFIG.colors.gold, emissive: CONFIG.colors.gold, emissiveIntensity: 2.0, metalness: 1.0, roughness: 0.0
            });
            const topStar = new THREE.Mesh(geo, mat);
            topStar.position.set(0, CONFIG.treeHeight / 2 + 40, 0);
            new TWEEN.Tween(topStar.rotation).to({y: Math.PI * 4}, 10000).repeat(Infinity).start();
            scene.add(topStar);
        }

        function createDecorations() {
            const sphereGeo = new THREE.SphereGeometry(1, 16, 16);
            const boxGeo = new THREE.BoxGeometry(1, 1, 1);
            const matGold = new THREE.MeshStandardMaterial({ color: CONFIG.colors.gold, roughness: 0.1, metalness: 1.0, emissive: CONFIG.colors.gold, emissiveIntensity: 0.5 });
            const matRed = new THREE.MeshStandardMaterial({ color: CONFIG.colors.red, roughness: 0.2, metalness: 0.8, emissive: CONFIG.colors.red, emissiveIntensity: 0.3 });
            const matDark = new THREE.MeshStandardMaterial({ color: CONFIG.colors.dark, roughness: 0.9, metalness: 0.2 });

            for (let i = 0; i < CONFIG.particleCount; i++) {
                let mesh, scaleBase, rnd = Math.random();
                if (rnd < 0.45) { mesh = new THREE.Mesh(sphereGeo, matGold); scaleBase = 6 + Math.random() * 8; } 
                else if (rnd < 0.75) { mesh = new THREE.Mesh(sphereGeo, matRed); scaleBase = 5 + Math.random() * 6; } 
                else { mesh = new THREE.Mesh(boxGeo, matDark); scaleBase = 4 + Math.random() * 5; mesh.rotation.set(Math.random()*6, Math.random()*6, Math.random()*6); }
                
                mesh.scale.setScalar(scaleBase);
                const theta = Math.random() * Math.PI * 2;
                const y = Math.pow(Math.random(), 0.9) * CONFIG.treeHeight - CONFIG.treeHeight / 2;
                const r = CONFIG.treeRadius * (1 - (y + CONFIG.treeHeight/2)/CONFIG.treeHeight) * Math.sqrt(Math.random());
                mesh.userData = {
                    treePos: { x: r * Math.cos(theta), y: y, z: r * Math.sin(theta) },
                    scatterPos: { x: (Math.random()-0.5)*1500, y: (Math.random()-0.5)*1500, z: (Math.random()-0.5)*1500 }
                };
                mesh.position.copy(mesh.userData.treePos);
                geometryGroup.add(mesh);
                particles.push(mesh);
            }
        }

        function loadMyPhotos() {
            const loader = new THREE.TextureLoader();
            MY_PHOTOS.forEach(path => {
                loader.load(path, (tex) => { createPhotoMesh(tex); }, undefined, 
                (err) => console.warn(`åŠ è½½ç…§ç‰‡å¤±è´¥: ${path}`));
            });
        }

        function createPhotoMesh(tex) {
            tex.colorSpace = THREE.SRGBColorSpace;
            // === ä¿®æ”¹ç‚¹ï¼šä½¿ç”¨ StandardMaterial ä»¥ä¾¿æ§åˆ¶äº®åº¦å’Œè¾‰å…‰ ===
            const geometry = new THREE.PlaneGeometry(32, 42);
            const material = new THREE.MeshStandardMaterial({
                map: tex,
                side: THREE.DoubleSide,
                roughness: 0.6,
                metalness: 0.0,
                color: CONFIG.photoBrightness.normal.color, // åˆå§‹é¢œè‰²
                emissive: 0xffffff,
                emissiveMap: tex,
                emissiveIntensity: CONFIG.photoBrightness.normal.intensity // åˆå§‹è‡ªå‘å…‰å¼ºåº¦
            });
            
            const mesh = new THREE.Mesh(geometry, material);
            const y = Math.random() * (CONFIG.treeHeight - 100) - (CONFIG.treeHeight/2 - 50);
            const r = CONFIG.treeRadius * (1 - (y + CONFIG.treeHeight/2)/CONFIG.treeHeight) + 20;
            const theta = Math.random() * Math.PI * 2;
            mesh.userData = {
                treePos: { x: r * Math.cos(theta), y: y, z: r * Math.sin(theta) },
                scatterPos: { x: (Math.random()-0.5)*1000, y: (Math.random()-0.5)*1000, z: (Math.random()-0.5)*1000 }
            };
            mesh.position.copy(mesh.userData.treePos);
            mesh.lookAt(0, y, 0);
            photoGroup.add(mesh);
            photos.push(mesh);
        }

        function transformTo(mode) {
            if(currentMode === mode) return;
            currentMode = mode;
            
            // é€€å‡ºæ”¾å¤§æ¨¡å¼æ—¶ï¼Œæ¢å¤ç…§ç‰‡äº®åº¦
            if(activePhoto) {
                new TWEEN.Tween(activePhoto.scale).to({x:1, y:1, z:1}, 800).start();
                // === ä¿®æ”¹ç‚¹ï¼šæ¢å¤äº®åº¦å’Œè‡ªå‘å…‰ ===
                new TWEEN.Tween(activePhoto.material).to({ emissiveIntensity: CONFIG.photoBrightness.normal.intensity }, 800).start();
                new TWEEN.Tween(activePhoto.material.color).to(CONFIG.photoBrightness.normal.color, 800).start();
                activePhoto = null;
            }

            const k = mode === 'TREE' ? 'treePos' : 'scatterPos';
            const ease = mode === 'TREE' ? TWEEN.Easing.Elastic.Out.config(1, 0.75) : TWEEN.Easing.Exponential.Out;
            particles.forEach(p => {
                new TWEEN.Tween(p.position).to(p.userData[k], 2000 + Math.random()*500).easing(ease).start();
                if(mode === 'SCATTER' && p.geometry.type === 'BoxGeometry') new TWEEN.Tween(p.rotation).to({x:Math.random()*6, y:Math.random()*6}, 2500).start();
            });
            photos.forEach(p => {
                new TWEEN.Tween(p.position).to(p.userData[k], 2000).easing(ease).onUpdate(() => { 
                    if(mode === 'SCATTER') p.lookAt(camera.position); else p.lookAt(0, p.position.y, 0); 
                }).start();
            });
        }

        function grabPhoto() {
            if(currentMode === 'ZOOM' || photos.length === 0) return;
            activePhoto = photos[Math.floor(Math.random() * photos.length)];
            currentMode = 'ZOOM';
            document.getElementById('gesture-status').innerText = "æŸ¥çœ‹ç…§ç‰‡";
            
            // === ä¿®æ”¹ç‚¹ï¼šæ”¾å¤§æ—¶å˜æš— ===
            // 1. é™ä½è‡ªå‘å…‰å¼ºåº¦ (å‡å°‘è¾‰å…‰)
            new TWEEN.Tween(activePhoto.material).to({ emissiveIntensity: CONFIG.photoBrightness.zoomed.intensity }, 1000).start();
            // 2.

